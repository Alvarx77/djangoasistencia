{% extends "alumnos/base.html" %}
{% block title %}Lista de Alumnos{% endblock %}

{% block content %}
<div class="card card-custom p-4">

  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h3 class="mb-3 mb-md-0">üìã Lista de Alumnos</h3>
    <!-- Bot√≥n Agregar (abre modal) -->
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAdd">
      ‚ûï Agregar estudiante
    </button>
  </div>

  <!-- Mensajes -->
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Filtros -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-4">
      <label for="curso" class="form-label">Curso:</label>
      <select name="curso" id="curso" class="form-select" onchange="this.form.submit()">
        <option value="">Todos</option>
        {% for curso in cursos %}
          <option value="{{ curso.nombre }}" {% if curso.nombre == curso_filtrado %}selected{% endif %}>
            {{ curso.nombre }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label for="nombre" class="form-label">Nombre del Alumno:</label>
      <input type="text" name="nombre" id="nombre" class="form-control" placeholder="Buscar..." value="{{ nombre_filtrado }}">
    </div>
    <div class="col-md-4 align-self-end d-grid">
      <button type="submit" class="btn btn-success">Aplicar Filtros</button>
    </div>
  </form>

  {% if alumnos %}
    <ul class="list-group">
      {% for alumno in alumnos %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ alumno.nombre_completo }}</strong>
            <span class="badge bg-secondary ms-2">{{ alumno.curso.nombre }}</span>
          </div>
          <div class="d-flex gap-2">
            <button
              class="btn btn-sm btn-warning"
              data-bs-toggle="modal"
              data-bs-target="#modalEdit"
              data-id="{{ alumno.id }}"
              data-nombre="{{ alumno.nombre_completo }}"
              data-curso-id="{{ alumno.curso.id }}"
            >‚úèÔ∏è Editar</button>

            <button
              class="btn btn-sm btn-outline-danger"
              data-bs-toggle="modal"
              data-bs-target="#modalDelete"
              data-id="{{ alumno.id }}"
              data-nombre="{{ alumno.nombre_completo }}"
            >üóë Eliminar</button>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="alert alert-warning mt-4" role="alert">
      No se encontraron alumnos con los criterios seleccionados.
    </div>
  {% endif %}
</div>

<!-- MODAL: Agregar -->
<div class="modal fade" id="modalAdd" tabindex="-1" aria-labelledby="modalAddLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="action" value="add">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAddLabel">Agregar estudiante</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Apellido paterno</label>
          <input type="text" name="ap_paterno" class="form-control upper" placeholder="EJ: PEREZ" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Apellido materno</label>
          <input type="text" name="ap_materno" class="form-control upper" placeholder="EJ: GONZALEZ" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Nombres</label>
          <input type="text" name="nombres" class="form-control upper" placeholder="EJ: JUAN CARLOS" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Curso</label>
          <select name="curso_id" class="form-select" required>
            <option value="" selected disabled>Seleccione...</option>
            {% for curso in cursos %}
              <option value="{{ curso.id }}">{{ curso.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <small class="text-muted">Se sugiere escribir en el orden: <strong>Apellido paterno</strong>, <strong>Apellido materno</strong>, <strong>Nombres</strong>. El sistema convertir√° todo a MAY√öSCULAS.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Agregar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Editar -->
<div class="modal fade" id="modalEdit" tabindex="-1" aria-labelledby="modalEditLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="action" value="edit">
      <input type="hidden" name="alumno_id" id="edit_id">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEditLabel">Editar estudiante</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Apellido paterno</label>
          <input type="text" name="ap_paterno" id="edit_ap_paterno" class="form-control upper" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Apellido materno</label>
          <input type="text" name="ap_materno" id="edit_ap_materno" class="form-control upper" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Nombres</label>
          <input type="text" name="nombres" id="edit_nombres" class="form-control upper" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Curso</label>
          <select name="curso_id" id="edit_curso" class="form-select" required>
            {% for curso in cursos %}
              <option value="{{ curso.id }}">{{ curso.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <small class="text-muted">Se sugiere mantener el orden: <strong>Apellido paterno</strong>, <strong>Apellido materno</strong>, <strong>Nombres</strong>. El sistema convertir√° todo a MAY√öSCULAS.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-warning">Guardar cambios</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: Eliminar -->
<div class="modal fade" id="modalDelete" tabindex="-1" aria-labelledby="modalDeleteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" class="modal-content">
      {% csrf_token %}
      <input type="hidden" name="action" value="delete">
      <input type="hidden" name="alumno_id" id="del_id">
      <div class="modal-header">
        <h5 class="modal-title" id="modalDeleteLabel">Eliminar estudiante</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p>¬øSeguro que deseas eliminar al estudiante <strong id="del_nombre"></strong>? Esta acci√≥n no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-outline-danger">Eliminar</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Convierte a MAY√öSCULAS en inputs con clase .upper
  document.addEventListener('input', function (e) {
    if (e.target.classList.contains('upper')) {
      const start = e.target.selectionStart;
      const end = e.target.selectionEnd;
      e.target.value = e.target.value.toUpperCase();
      // Mant√©n el cursor
      e.target.setSelectionRange(start, end);
    }
  });

  // Prellenar modal de Edici√≥n: separa nombre_completo en 3 partes (aprox):
  // 1¬™ palabra => paterno, 2¬™ => materno, resto => nombres
  const modalEdit = document.getElementById('modalEdit');
  modalEdit.addEventListener('show.bs.modal', function (event) {
    const btn = event.relatedTarget;
    const id = btn.getAttribute('data-id');
    const nombre = (btn.getAttribute('data-nombre') || '').toUpperCase().trim();
    const cursoId = btn.getAttribute('data-curso-id');

    const tokens = nombre.split(/\s+/);
    let apP = '', apM = '', noms = '';
    if (tokens.length >= 3) {
      apP = tokens[0];
      apM = tokens[1];
      noms = tokens.slice(2).join(' ');
    } else if (tokens.length == 2) {
      apP = tokens[0];
      noms = tokens[1];
    } else if (tokens.length == 1) {
      noms = tokens[0];
    }

    modalEdit.querySelector('#edit_id').value = id;
    modalEdit.querySelector('#edit_ap_paterno').value = apP;
    modalEdit.querySelector('#edit_ap_materno').value = apM;
    modalEdit.querySelector('#edit_nombres').value = noms;
    modalEdit.querySelector('#edit_curso').value = cursoId;
  });

  // Prellenar modal de Eliminaci√≥n
  const modalDelete = document.getElementById('modalDelete');
  modalDelete.addEventListener('show.bs.modal', function (event) {
    const btn = event.relatedTarget;
    const id = btn.getAttribute('data-id');
    const nombre = btn.getAttribute('data-nombre');
    modalDelete.querySelector('#del_id').value = id;
    modalDelete.querySelector('#del_nombre').textContent = nombre;
  });
</script>
{% endblock %}
